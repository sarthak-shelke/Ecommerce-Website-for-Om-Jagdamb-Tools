</div>
</div>

<script>
    // Form validation functions (UNCHANGED - keep these for user feedback)
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    function validatePassword(password) {
        // At least 8 characters, 1 uppercase, 1 lowercase, 1 number (matches your Django serializer logic)
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/; 
        return passwordRegex.test(password);
    }
    
    function validateUsername(username) {
        const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
        return usernameRegex.test(username);
    }
    
    function validateName(name) {
        const nameRegex = /^[a-zA-Z]{2,}$/;
        return nameRegex.test(name);
    }
    
    function showError(message) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = message;
        errorElement.style.color = '#e53e3e';
        errorElement.style.display = 'block';
    }
    
    function showSuccess(message) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = message;
        errorElement.style.color = '#28a745';
        errorElement.style.display = 'block';
    }
    
    function clearMessage() {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = '';
        errorElement.style.display = 'none';
    }

    // --- NEW API SUBMISSION LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('signupForm');
        const submitBtn = document.getElementById('signup-btn');

        // Input References
        const username = document.getElementById('username');
        const email = document.getElementById('email');
        const firstName = document.getElementById('first-name');
        const lastName = document.getElementById('last-name');
        const password = document.getElementById('password');
        const passwordConfirm = document.getElementById('password-confirm');
        
        // --- REAL-TIME VALIDATION (Keep the user feedback) ---
        // (You can uncomment and re-add your real-time listeners here if you want them)

        // --- FORM SUBMISSION HANDLER ---
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            clearMessage();
            
            const data = {
                username: username.value.trim(),
                email: email.value.trim(),
                first_name: firstName.value.trim(), // Django expects first_name
                last_name: lastName.value.trim(),   // Django expects last_name
                password: password.value,
                password_confirm: passwordConfirm.value
            };
            
            // --- Frontend Validation Check (Critical) ---
            if (!data.username || !data.email || !data.first_name || !data.last_name || !data.password || !data.password_confirm) {
                showError('Please fill in all fields');
                return;
            }
            if (data.password !== data.password_confirm) {
                showError('Passwords do not match');
                return;
            }
            if (!validatePassword(data.password)) {
                showError('Password must be at least 8 characters with uppercase, lowercase, and number');
                return;
            }
            // Add other validation checks here (username, email format, etc.)

            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Creating Account...';
            submitBtn.disabled = true;

            const registerApiUrl = 'http://127.0.0.1:8000/api/auth/register/';

            try {
                const response = await fetch(registerApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();
                
                if (response.ok) {
                    // SUCCESS! Django sends back the user and token on successful registration
                    if (responseData.token) {
                        localStorage.setItem('authToken', responseData.token); // Save token
                        
                        showSuccess('Account created! Logging in...');
                        submitBtn.style.background = '#28a745';
                        submitBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>Success!';
                        
                        // Redirect after successful login/registration
                        setTimeout(() => {
                            window.location.href = 'index.html'; 
                        }, 1500);
                    } else {
                        throw new Error('Registration succeeded, but no login token was received.');
                    }
                } else {
                    // FAILURE: Handle API validation errors (e.g., username already exists)
                    let errorMessage = 'Registration failed due to an unknown error.';
                    if (responseData) {
                        // Display the error text for the user
                        errorMessage = JSON.stringify(responseData); 
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                // Network or internal error
                console.error('Sign Up Error:', error);
                
                let messageToUser = 'Registration failed. Check your input and try again.';
                
                // Try to parse specific validation errors (e.g., "Username already exists")
                if (error.message.includes('unique constraint') || error.message.includes('exists')) {
                    messageToUser = 'Username or email is already registered.';
                } else if (error.message.includes('Failed to fetch')) {
                    messageToUser = 'Server connection failed. Is Django running?';
                } else if (error.message.includes('{')) {
                     // Attempt to show detailed validation errors from Django (like required fields)
                    try {
                        const errorJson = JSON.parse(error.message);
                        messageToUser = Object.keys(errorJson).map(key => `${key.replace(/_/g, ' ')}: ${errorJson[key][0]}`).join(', ');
                    } catch { /* Use default message */ }
                }

                showError(messageToUser);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    });
</script>

<script src="script.js" defer></script>
</body>
</html>